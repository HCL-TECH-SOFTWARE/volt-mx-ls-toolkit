<?xml version='1.0' encoding='utf-8'?>
<agent name='(TestAgent)' xmlns='http://www.lotus.com/dxl' version='11.0'
 maintenanceversion='1.0' replicaid='8025872B003E39F1' hide='v3' publicaccess='false'
 designerversion='8.5.3'>
<noteinfo noteid='1d2' unid='17703828215018978025872B0040EBF4' sequence='21'>
<created><datetime dst='true'>20210808T124907,08+01</datetime></created>
<modified><datetime dst='true'>20210808T163500,86+01</datetime></modified>
<revised><datetime dst='true'>20210808T162608,79+01</datetime></revised>
<lastaccessed><datetime dst='true'>20210808T163500,85+01</datetime></lastaccessed>
<addedtofile><datetime dst='true'>20210808T124907,53+01</datetime></addedtofile></noteinfo>
<updatedby><name>CN=Paul Withers/OU=UK/O=PNPHCL</name></updatedby>
<wassignedby><name>CN=Paul Withers/OU=UK/O=PNPHCL</name></wassignedby>
<designchange><datetime dst='true'>20210808T162608,76+01</datetime></designchange>
<trigger type='agentlist'/>
<documentset type='runonce'/><code event='options'><lotusscript>%REM
	Copyright 2020 Paul Withers, HCL
	Licensed under the Apache License, Version 2.0 (the "License"); 
	you may not use this file except in compliance with the License. 
	You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, 
	software distributed under the License is distributed on an "AS IS" BASIS, 
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
	See the License for the specific language governing permissions and limitations under the License
	
	Agent to extract basic information from a request,
	demonstrating the methods available for a JSON request.
	
	A POST request to this agent should be made from Postman, Node-RED or other tool.
	Content-Type header should be set as "application/json".
	Request body should be:
	{
		"unid": "83BB7276C4E41B7400258614003C9187",
		"payload": {
			"FirstName": "Adrian"
			"TestVal": 20,
			"TestBoolean": false
		},
		"foo": "bar",
		"docs": [
			{
				"unid": "123456",
				"FirstName": "Fred",
				"LastName": "Bloggs"
			},
			{
				"unid": "234567",
				"FirstName": "John",
				"LastName": "Doe"
			},
			{
				"unid": "345678",
				"FirstName": "Jane",
				"LastName": "Doe"
			}
		]
	}
	
	The agent will log content to OpenLog, send back a JSON object "hello": "world",
	and echo the names from the docs array
%END REM
Option Public
Option Declare
Use "NotesHttpJsonRequestHelper"

</lotusscript></code><code event='initialize'><lotusscript>Sub Initialize
	Dim s As New NotesSession
	Dim doc As NotesDocument
	Dim httpRequest As NotesAgent_JsonHTTPHelper
	Dim tmpStr As String
	
	On Error Goto logErr
	
	Call instantiateNotesHttplog()
	
	Set doc = s.Documentcontext
	Set httpRequest = New NotesAgent_JsonHTTPHelper(doc)
	httpRequest.LogErrorOnBadPointer = True
	If (httpRequest.isWebRequest()) Then
		If (httpRequest.IsValid()) Then
			If (httpRequest.Method = "POST") Then
				enhLogAction ||, |This was a POST request|
			Else
				Call httpRequest.closeRequestWithError(httpRequest.Method &amp; " is not a valid HTTP method for this endpoint", HTTP_STATUS_INVALID_METHOD)
				Exit Sub
			End If
			enhLogAction ||, |ContentType: | &amp; httpRequest.ContentType
			enhLogAction ||, |Base URL: | &amp; httpRequest.BaseUrl
			enhLogAction ||, |Header keys: | &amp; Implode(httpRequest.HeaderKeys, ",")
			enhLogAction ||, |JWT token: | &amp; httpRequest.GetHeader("X-AUTH-TOKEN")
			enhLogAction ||, |Query param keys: | &amp; Implode(httpRequest.QueryParamKeys, ",")
			enhLogAction ||, |Query param: | &amp; httpRequest.GetQueryParam("foo")
			enhLogAction ||, |Body as String: | &amp; Replace(httpRequest.GetRequestBodyAsStringSingleLine(), Chr(13), "")
			enhLogAction ||, |Body as JSON: | &amp; httpRequest.RequestBodyAsJson().Stringify()
			Call httpRequest.findStringByPointer("/foo", tmpStr)
			enhLogAction ||, |foo string: | &amp; tmpStr
			
			' Old Style
			Dim arr As NotesJSONArray
			Dim obj As NotesJSONObject
			Call httpRequest.findJsonArrayByPointer("/docs", arr)
			Set obj = arr.Getfirstelement().value
			enhLogAction ||, |Getting name: | &amp; obj.Getelementbyname("FirstName").Value
			
			Call httpRequest.findStringByPointer("/docs/1/FirstName", tmpStr)
			enhLogAction ||, |first name of first doc: | &amp; tmpStr
			
			Dim badVal As String
			Call httpRequest.findStringByPointer("/bar", badVal)
			If (badVal = "") Then
				enhLogAction ||, |bar variable doesn't exist|
			Else
				enhLogAction ||, |Something REALLY went wrong, because this shouldn't be here|
			End If
			
			Dim badDbl As Double
			If (httpRequest.findDoubleByPointer("/bars", badDbl)) Then
				enhLogAction ||, |Something REALLY went wrong, because bars variable shouldn't be here|
			Else
				enhLogAction ||, |bars number doesn't exist|
			End If
			
			Dim count As Integer
			count = 1
			Forall names In httpRequest.GetNotesJSONElementsFromArray(s, "/docs", "/FirstName")
				enhLogAction ||, Cstr(count) &amp; ". " &amp; names.value
				count = count + 1
			End Forall
			Call httpRequest.addResponseHeader("Content-Type", "application/json").addResponseHeader("X-AUTH-TOKEN", "Foo")
			Call httpRequest.getJSONResponseBody().AppendelementFluent("World", "Hello").appendArray("names").appendElementFluent("Fred Bloggs").appendElementFluent("John Doe").appendElementFluent("Jane Doe")
		Else
			enhLogAction ||, |"***NOT JSON***|
			Call httpRequest.closeRequestWithError("A JSON body and Content-Type as application/json is expected", HTTP_STATUS_BAD_REQUEST)
		End If
	End If
	
ExitPoint:
	
	Exit Sub
	
logErr:   
	Messagebox "Error" &amp; Str(Err) &amp; ": " &amp; Error$ &amp; "," &amp; Erl
	enhLogAction ||, ||
	Call httpRequest.closeRequestWithError(Str(Err) &amp; ": " &amp; Error$ &amp; "," &amp; Cstr(Erl), HTTP_STATUS_CODE_ERROR)
	Resume exitPoint
End Sub</lotusscript></code>
<rundata processeddocs='0' exitcode='0' agentdata='F9729F55088577BF8025872B00532A58'>
<agentmodified><datetime dst='true'>20210808T162608,80+01</datetime></agentmodified>
<agentrun><datetime dst='true'>20210808T163144,83+01</datetime></agentrun>
<runlog>Started running agent 'TestAgent' on 08/08/2021 16:31:44
Ran LotusScript code
Done running agent 'TestAgent' on 08/08/2021 16:31:44
</runlog></rundata></agent>

