<?xml version='1.0' encoding='utf-8'?>
<agent name='(TestAgent)' xmlns='http://www.lotus.com/dxl' version='11.0'
 maintenanceversion='1.0' replicaid='00258602004A9092' hide='v3' publicaccess='false'
 designerversion='8.5.3'>
<noteinfo noteid='17a' unid='7D1F2760B57296B880258602003B2D2C' sequence='5'>
<created><datetime dst='true'>20201015T114621,88+01</datetime></created>
<modified><datetime>20201021T155434,65+00</datetime></modified>
<revised><datetime>20201021T155434,64+00</datetime></revised>
<lastaccessed><datetime>20201021T155434,64+00</datetime></lastaccessed>
<addedtofile><datetime>20201015T133432,16+00</datetime></addedtofile></noteinfo>
<updatedby><name>CN=Paul Withers/OU=UK/O=PNPHCL</name></updatedby>
<wassignedby><name>CN=Paul Withers/OU=UK/O=PNPHCL</name></wassignedby>
<designchange><datetime dst='true'>20201021T165432,24+01</datetime></designchange>
<trigger type='agentlist'/>
<documentset type='runonce'/><code event='options'><lotusscript>%REM
	Agent TestAgent
	Created Oct 9, 2020 by Paul S Withers/paulswithers
	Description: Comments for Agent
%END REM
Option Public
Option Declare
Use "NotesHttpJsonRequestHelper"

</lotusscript></code><code event='initialize'><lotusscript>Sub Initialize
	Dim s As New NotesSession
	Dim doc As NotesDocument
	Dim httpRequest As NotesAgent_JsonHTTPHelper
	Dim tmpStr As String
	
	On Error Goto logErr
	
	Set doc = s.Documentcontext
	Set httpRequest = New NotesAgent_JsonHTTPHelper(doc)
	Call httpRequest.SetLogErrorOnBadPointer(True)
	If (httpRequest.isWebRequest()) Then
		If (httpRequest.IsValid()) Then
			Msgbox "Yay, valid doc"
			If (httpRequest.GetMethod() = "POST") Then
				Msgbox "This was a POST request"
			Else
				Call httpRequest.closeRequestWithError(httpRequest.GetMethod() &amp; " is not a valid HTTP method for this endpoint", HTTP_STATUS_INVALID_METHOD)
				Exit Sub
			End If
			Msgbox "ContentType: " &amp; httpRequest.GetContentType()
			Msgbox "Base URL: " &amp; httpRequest.GetBaseUrl()
			Msgbox "JWT token: " &amp; httpRequest.GetHeader("X-AUTH-TOKEN")
			Msgbox "Query param: " &amp; httpRequest.GetQueryParam("foo")
			Msgbox "Body as String: " &amp; Replace(httpRequest.GetRequestBodyAsStringSingleLine(), Chr(13), "")
			Msgbox ""
			Msgbox "Body as JSON: " &amp; httpRequest.getRequestBodyAsJson().Stringify()
			Call httpRequest.findStringByPointer("/foo", tmpStr)
			Msgbox "Hello string: " &amp; tmpStr
			Msgbox "Callback URL: " &amp; httpRequest.getCallbackUrl()
			
			Sleep (10)
			
			' Old Style
			Dim arr As NotesJSONArray
			Dim obj As NotesJSONObject
			Call httpRequest.findJsonArrayByPointer("/docs", arr)
			Set obj = arr.Getfirstelement().value
			Msgbox "Getting name: " &amp; obj.Getelementbyname("FirstName").Value
			
			Call httpRequest.findStringByPointer("/docs/1/FirstName", tmpStr)
			Msgbox tmpStr
			
			Dim badVal As String
			Call httpRequest.findStringByPointer("/bar", badVal)
			If (badVal = "") Then
				Msgbox "Doesn't exist"
			Else
				Msgbox "Something REALLY went wrong, because this shouldn't be here"
			End If
			
			Dim badDbl As Double
			If (httpRequest.findDoubleByPointer("/bars", badDbl)) Then
				Msgbox "Something REALLY went wrong, because this shouldn't be here"
			Else
				Msgbox "Number doesn't exist"
			End If
			
			Dim count As Integer
			count = 1
			Forall names In httpRequest.GetNotesJSONElementsFromArray(s, "/docs", "/FirstName")
				Msgbox Cstr(count) &amp; ". " &amp; names.value
				count = count + 1
			End Forall
			Call httpRequest.addResponseHeader("Content-Type", "application/json").addResponseHeader("X-AUTH-TOKEN", "Foo")
			Call httpRequest.getJSONResponseBody().AppendelementFluent("World", "Hello").appendArray("names").appendElementFluent("Fred Bloggs").appendElementFluent("John Doe").appendElementFluent("Jane Doe")
		Else
			Msgbox "***NOT JSON***"
			Call httpRequest.closeRequestWithError("A JSON body and Content-Type as application/json is expected", HTTP_STATUS_BAD_REQUEST)
		End If
	End If
	
	Exit Sub
	
logErr:   
	Messagebox "Error" &amp; Str(Err) &amp; ": " &amp; Error$ &amp; "," &amp; Erl
	Call LogError()
	Call httpRequest.closeRequestWithError(Str(Err) &amp; ": " &amp; Error$ &amp; "," &amp; Cstr(Erl), HTTP_STATUS_CODE_ERROR)
	Exit Sub
End Sub</lotusscript></code>
<rundata processeddocs='0' exitcode='0' agentdata='8DD804DC788AFBF300258608005767CD'>
<agentmodified><datetime>20201021T155434,65+00</datetime></agentmodified>
<agentrun><datetime>20201029T163819,85+00</datetime></agentrun>
<runlog>Started running agent 'TestAgent' on 10/29/2020 04:38:09 PM
Ran LotusScript code
Done running agent 'TestAgent' on 10/29/2020 04:38:19 PM
</runlog></rundata></agent>

